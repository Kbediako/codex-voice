#!/data/data/com.termux/files/usr/bin/sh

VOICE_DIR="$HOME/.codex/device"
PID_FILE="$VOICE_DIR/voice.pid"
LOG_FILE="$VOICE_DIR/voice.log"
NOTIF_VOICE_ID=9101
NOTIF_CTRL_ID=9102

mkdir -p "$VOICE_DIR"

termux-notification-remove -i "$NOTIF_VOICE_ID" >/dev/null 2>&1 || true
termux-notification-remove -i "$NOTIF_CTRL_ID" >/dev/null 2>&1 || true

# Ensure only one listener by stopping any lingering instances first.
"$HOME/bin/codex-voice-off" >/dev/null 2>&1 || true
sleep 0.3

if pgrep -f "/codex-voice([[:space:]]|$)" >/dev/null 2>&1; then
  termux-toast "Codex voice already running" >/dev/null 2>&1 || true
  exit 0
fi

nohup setsid "$HOME/bin/codex-voice" >"$LOG_FILE" 2>&1 </dev/null &
new_pid=$!

echo "$new_pid" > "$PID_FILE"
termux-toast "Codex voice started" >/dev/null 2>&1 || true
