#!/data/data/com.termux/files/usr/bin/sh

HOME_DIR="$HOME"
VOICE_DIR="$HOME_DIR/.codex/device"
PID_FILE="$VOICE_DIR/voice.pid"
LOG_FILE="$VOICE_DIR/voice.log"
VOICE_BIN="$HOME_DIR/codex-voice/bin/codex-voice"
PANEL_BIN="$HOME_DIR/codex-voice/bin/codex-voice-panel"

mkdir -p "$VOICE_DIR"

if [ -f "$PID_FILE" ]; then
  pid=$(cat "$PID_FILE" 2>/dev/null || true)
  if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    "$PANEL_BIN" >/dev/null 2>&1 || true
    exit 0
  fi
fi

nohup setsid "$VOICE_BIN" > "$LOG_FILE" 2>&1 </dev/null &
new_pid=$!
printf '%s\n' "$new_pid" > "$PID_FILE"

sleep 0.2
"$PANEL_BIN" >/dev/null 2>&1 || true
